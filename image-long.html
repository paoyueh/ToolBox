<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ–ç‰‡æ‹¼æ¥å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-2 sm:p-6">
    <div class="max-w-4xl mx-auto w-full">
        
        <div class="mb-4">
            <a href="index.html" class="inline-flex items-center text-gray-600 hover:text-blue-600 transition-colors bg-white/50 px-3 py-1.5 rounded-lg hover:bg-white">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                è¿”å›å·¥å…·ç®±
            </a>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-8">
            <div class="mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2 text-center">åœ–ç‰‡æ‹¼æ¥å·¥å…·</h1>
                <p class="text-sm sm:text-base text-gray-600 text-center">æŒ‰æª”åé †åºå°‡åœ–ç‰‡å¾ä¸Šåˆ°ä¸‹æ‹¼æ¥æˆé•·åœ–</p>
                <div class="w-full h-px bg-gray-200 mt-4"></div>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-4 sm:p-6 mb-4 sm:mb-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™å¯¬åº¦ (åƒç´ )</label>
                        <input type="number" id="targetWidth" value="1000" min="100" max="2000" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åœ–ç‰‡é–“è· (åƒç´ )</label>
                        <input type="number" id="imageSpacing" value="0" min="0" max="50" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¼¸å‡ºæ ¼å¼</label>
                        <select id="outputFormat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="jpeg">JPG</option>
                            <option value="png">PNG</option>
                        </select>
                        <div class="mt-2 text-xs text-gray-500">
                            <div>â€¢ JPGï¼š90% å“è³ªå£“ç¸®ï¼Œæª”æ¡ˆè¼ƒå°</div>
                            <div>â€¢ PNGï¼šç„¡æå“è³ªï¼Œæ”¯æ´é€æ˜èƒŒæ™¯</div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åœ–ç‰‡åç¨±</label>
                        <input type="text" id="customFileName" value="æ‹¼æ¥é•·åœ–" placeholder="è¼¸å…¥æª”æ¡ˆåç¨±" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div class="mt-1 text-xs text-gray-500">ç³»çµ±æœƒè‡ªå‹•åŠ ä¸Šæ™‚é–“æˆ³è¨˜å’Œå‰¯æª”å</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å„²å­˜ä½ç½®</label>
                        <div class="flex gap-2">
                            <input type="text" id="saveLocation" value="ä¸‹è¼‰è³‡æ–™å¤¾" readonly 
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
                            <button id="chooseFolderBtn" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                                é¸æ“‡
                            </button>
                        </div>
                        <div class="mt-1 text-xs text-gray-500">Chrome/Edge æ”¯æ´è‡ªè¨‚ä½ç½®ï¼ŒSafari ä½¿ç”¨é è¨­ä¸‹è¼‰è³‡æ–™å¤¾</div>
                    </div>
                </div>
            </div>

            <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 sm:p-8 text-center mb-4 sm:mb-6 hover:border-blue-400 transition-colors">
                <input type="file" id="imageInput" multiple accept="image/*" class="hidden">
                <div id="uploadArea" class="cursor-pointer">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <p class="text-base sm:text-lg text-gray-600 mb-2">é»æ“Šé¸æ“‡åœ–ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤è™•</p>
                    <p class="text-xs sm:text-sm text-gray-500">æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼ï¼Œå¯é¸æ“‡å¤šå¼µåœ–ç‰‡</p>
                </div>
            </div>

            <div id="imagePreview" class="hidden mb-4 sm:mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800">å·²é¸æ“‡çš„åœ–ç‰‡ <span class="hidden sm:inline">(å¯æ‹–æ‹½èª¿æ•´é †åº)</span></h3>
                    <div class="flex gap-2">
                        <button id="addMoreBtn" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                            + ç¹¼çºŒæ·»åŠ 
                        </button>
                        <button id="clearAllBtn" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                            æ¸…ç©ºå…¨éƒ¨
                        </button>
                    </div>
                </div>
                <div id="imageList" class="space-y-2 overflow-y-auto" style="max-height: none;"></div>
                <div class="text-sm text-gray-500 mt-2 space-y-1">
                    <p>ğŸ’¡ æç¤ºï¼š</p>
                    <p>â€¢ é»æ“Šåœ–ç‰‡å¯é¸æ“‡ï¼ŒCtrl/Cmd+é»æ“Šå¤šé¸ï¼ŒShift+é»æ“Šç¯„åœé¸æ“‡</p>
                    <p>â€¢ æ‹–æ‹½åœ–ç‰‡å¯èª¿æ•´é †åºï¼Œæ”¯æ´å¤šé¸åœ–ç‰‡ä¸€èµ·ç§»å‹•</p>
                    <p>â€¢ æ‹¼æ¥æ™‚æœƒæŒ‰ç…§ç•¶å‰é †åºåŸ·è¡Œ</p>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mb-4 sm:mb-6">
                <button id="processBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                    é–‹å§‹æ‹¼æ¥
                </button>
                <button id="reprocessBtn" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors hidden">
                    å†æ¬¡æ‹¼æ¥
                </button>
                <button id="downloadBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors hidden">
                    ä¸‹è¼‰é•·åœ–
                </button>
            </div>

            <div id="progressArea" class="hidden mb-4 sm:mb-6">
                <div class="bg-gray-200 rounded-full h-2 mb-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-600 text-center">æº–å‚™ä¸­...</p>
            </div>

            <div id="resultArea" class="hidden">
                <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">âœ… æ‹¼æ¥å®Œæˆï¼</h3>
                <div class="border-2 border-green-200 rounded-lg p-3 sm:p-4 bg-green-50">
                    <div class="mb-3">
                        <p class="text-xs sm:text-sm text-gray-600 mb-2">ğŸ“ æœ€çµ‚å°ºå¯¸ï¼š<span id="finalDimensions" class="font-semibold"></span></p>
                        <p class="text-xs sm:text-sm text-gray-600">ğŸ’¡ å¯ä»¥æ»¾å‹•æŸ¥çœ‹å®Œæ•´åœ–ç‰‡ï¼Œæˆ–é»æ“Šä¸‹è¼‰æŒ‰éˆ•ä¿å­˜</p>
                    </div>
                    <div class="border-2 border-gray-300 rounded-lg bg-white p-1 sm:p-2 max-h-64 sm:max-h-96 overflow-auto">
                        <canvas id="resultCanvas" class="max-w-full h-auto shadow-sm"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const imageList = document.getElementById('imageList');
        const processBtn = document.getElementById('processBtn');
        const reprocessBtn = document.getElementById('reprocessBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressArea = document.getElementById('progressArea');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const resultArea = document.getElementById('resultArea');
        const resultCanvas = document.getElementById('resultCanvas');
        const targetWidthInput = document.getElementById('targetWidth');
        const imageSpacingInput = document.getElementById('imageSpacing');
        const outputFormatInput = document.getElementById('outputFormat');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const customFileNameInput = document.getElementById('customFileName');
        const saveLocationInput = document.getElementById('saveLocation');
        const chooseFolderBtn = document.getElementById('chooseFolderBtn');

        let selectedImages = [];
        let draggedIndex = null;
        let customSaveHandle = null;
        let selectedIndices = new Set();
        let isDragging = false;

        uploadArea.addEventListener('click', () => { imageInput.click(); });
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('bg-blue-50'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('bg-blue-50'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('bg-blue-50'); const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/')); handleFiles(files); });
        imageInput.addEventListener('change', (e) => { const files = Array.from(e.target.files); handleFiles(files); });
        addMoreBtn.addEventListener('click', () => { imageInput.click(); });
        
        clearAllBtn.addEventListener('click', () => {
            selectedImages = []; selectedIndices.clear(); imagePreview.classList.add('hidden'); processBtn.disabled = true;
            processBtn.textContent = 'é–‹å§‹æ‹¼æ¥'; processBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            processBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); reprocessBtn.classList.add('hidden');
            downloadBtn.classList.add('hidden'); resultArea.classList.add('hidden'); progressArea.classList.add('hidden');
            customFileNameInput.value = 'æ‹¼æ¥é•·åœ–';
        });

        chooseFolderBtn.addEventListener('click', async () => {
            try {
                if ('showDirectoryPicker' in window) {
                    customSaveHandle = await window.showDirectoryPicker();
                    saveLocationInput.value = customSaveHandle.name || 'è‡ªè¨‚è³‡æ–™å¤¾';
                } else {
                    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    let message = 'æ­¤åŠŸèƒ½éœ€è¦è¼ƒæ–°ç‰ˆæœ¬çš„ç€è¦½å™¨æ”¯æ´ã€‚\n\n';
                    if (isSafari || isIOS) { message += 'Safari ç”¨æˆ¶å»ºè­°ï¼š\næª”æ¡ˆæœƒè‡ªå‹•ä¸‹è¼‰åˆ°ã€Œä¸‹è¼‰é …ç›®ã€è³‡æ–™å¤¾\n'; } 
                    else { message += 'å»ºè­°ä½¿ç”¨ Chromeã€Edge æˆ– Firefox æœ€æ–°ç‰ˆæœ¬\n'; }
                    alert(message);
                }
            } catch (error) { if (error.name !== 'AbortError') console.log('Error:', error); }
        });

        function handleDragStart(e) {
            isDragging = true; draggedIndex = parseInt(e.target.dataset.index);
            if (!selectedIndices.has(draggedIndex)) { selectedIndices.clear(); selectedIndices.add(draggedIndex); updateSelectionDisplay(); }
            const selectedItems = Array.from(selectedIndices).sort((a, b) => a - b);
            selectedItems.forEach(index => { const item = document.querySelector(`[data-index="${index}"]`); if (item) item.style.opacity = '0.5'; });
            e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', JSON.stringify(Array.from(selectedIndices)));
        }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
        function handleDrop(e) {
            e.preventDefault(); const dropTarget = e.target.closest('[data-index]'); if (!dropTarget) return;
            const dropIndex = parseInt(dropTarget.dataset.index); const draggedIndices = JSON.parse(e.dataTransfer.getData('text/plain'));
            if (draggedIndices.length > 0 && !draggedIndices.includes(dropIndex)) {
                const itemsToMove = draggedIndices.sort((a, b) => a - b).map(index => ({ index: index, item: selectedImages[index] }));
                for (let i = itemsToMove.length - 1; i >= 0; i--) { selectedImages.splice(itemsToMove[i].index, 1); }
                let newDropIndex = dropIndex; for (const item of itemsToMove) { if (item.index < dropIndex) { newDropIndex--; } }
                for (let i = 0; i < itemsToMove.length; i++) { selectedImages.splice(newDropIndex + i, 0, itemsToMove[i].item); }
                selectedIndices.clear(); for (let i = 0; i < itemsToMove.length; i++) { selectedIndices.add(newDropIndex + i); }
                displayImagePreview();
            }
        }
        function handleDragEnd(e) { isDragging = false; document.querySelectorAll('[data-index]').forEach(item => { item.style.opacity = '1'; }); draggedIndex = null; }
        function updateSelectionDisplay() {
            document.querySelectorAll('[data-index]').forEach((item, index) => {
                const isSelected = selectedIndices.has(index);
                if (isSelected) { item.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50'); } 
                else { item.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50'); }
            });
        }
        function handleImageClick(e, index) {
            if (isDragging) return; e.preventDefault(); e.stopPropagation();
            if (e.ctrlKey || e.metaKey) { if (selectedIndices.has(index)) selectedIndices.delete(index); else selectedIndices.add(index); } 
            else if (e.shiftKey && selectedIndices.size > 0) {
                const lastSelected = Math.max(...selectedIndices); const start = Math.min(index, lastSelected); const end = Math.max(index, lastSelected);
                selectedIndices.clear(); for (let i = start; i <= end; i++) { selectedIndices.add(i); }
            } else { selectedIndices.clear(); selectedIndices.add(index); }
            updateSelectionDisplay();
        }
        function removeImage(index) {
            if (selectedIndices.has(index)) {
                const indicesToRemove = Array.from(selectedIndices).sort((a, b) => b - a);
                indicesToRemove.forEach(i => { selectedImages.splice(i, 1); }); selectedIndices.clear();
            } else {
                selectedImages.splice(index, 1);
                const newSelectedIndices = new Set(); selectedIndices.forEach(i => { if (i < index) newSelectedIndices.add(i); else if (i > index) newSelectedIndices.add(i - 1); }); selectedIndices = newSelectedIndices;
            }
            if (selectedImages.length === 0) { imagePreview.classList.add('hidden'); processBtn.disabled = true; } else { displayImagePreview(); }
        }
        function handleFiles(files) {
            if (files.length === 0) return;
            const newFiles = Array.from(files).filter(newFile => !selectedImages.some(existing => existing.name === newFile.name));
            selectedImages = [...selectedImages, ...newFiles].sort((a, b) => a.name.localeCompare(b.name));
            displayImagePreview(); processBtn.disabled = selectedImages.length === 0;
        }
        function displayImagePreview() {
            imageList.innerHTML = ''; imagePreview.classList.remove('hidden');
            const maxVisibleImages = 20; const imageItemHeight = 100;
            if (selectedImages.length <= maxVisibleImages) { imageList.style.maxHeight = 'none'; } 
            else { imageList.style.maxHeight = (maxVisibleImages * imageItemHeight) + 'px'; }
            selectedImages.forEach((file, index) => {
                const div = document.createElement('div'); div.className = 'flex items-center space-x-3 p-3 bg-white rounded-lg border cursor-move hover:bg-gray-50 transition-colors'; div.draggable = true; div.dataset.index = index;
                const dragHandle = document.createElement('div'); dragHandle.className = 'text-gray-400 hover:text-gray-600 select-none'; dragHandle.innerHTML = 'â‹®â‹®';
                const img = document.createElement('img'); img.className = 'w-36 h-24 object-contain rounded pointer-events-none bg-gray-100'; img.src = URL.createObjectURL(file); img.onload = () => URL.revokeObjectURL(img.src);
                const info = document.createElement('div'); info.className = 'flex-1 min-w-0 pointer-events-none'; info.innerHTML = `<p class="font-medium text-gray-800 text-sm truncate">${file.name}</p><p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>`;
                const controls = document.createElement('div'); controls.className = 'flex items-center space-x-2';
                const order = document.createElement('div'); order.className = 'text-sm font-semibold text-blue-600 bg-blue-100 px-2 py-1 rounded pointer-events-none'; order.textContent = `#${index + 1}`;
                const removeBtn = document.createElement('button'); removeBtn.className = 'text-red-500 hover:text-red-700 text-sm font-bold w-6 h-6 rounded-full hover:bg-red-100 transition-colors z-10'; removeBtn.innerHTML = 'Ã—'; removeBtn.onclick = (e) => { e.stopPropagation(); removeImage(index); };
                controls.appendChild(order); controls.appendChild(removeBtn);
                div.appendChild(dragHandle); div.appendChild(img); div.appendChild(info); div.appendChild(controls);
                div.addEventListener('click', (e) => handleImageClick(e, index));
                div.addEventListener('dragstart', handleDragStart); div.addEventListener('dragover', handleDragOver); div.addEventListener('drop', handleDrop); div.addEventListener('dragend', handleDragEnd);
                imageList.appendChild(div);
            });
            updateSelectionDisplay();
        }

        reprocessBtn.addEventListener('click', async () => { runProcess(); });
        processBtn.addEventListener('click', async () => { runProcess(); });

        async function runProcess() {
            if (selectedImages.length === 0) return;
            processBtn.disabled = true; processBtn.textContent = 'è™•ç†ä¸­...'; processBtn.classList.add('animate-pulse');
            if(processBtn.classList.contains('bg-green-600')) { processBtn.classList.remove('bg-green-600', 'hover:bg-green-700'); processBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); }
            reprocessBtn.classList.add('hidden'); downloadBtn.classList.add('hidden'); progressArea.classList.remove('hidden');
            progressBar.style.width = '0%'; progressText.textContent = 'æº–å‚™è™•ç†åœ–ç‰‡...';
            const targetWidth = parseInt(targetWidthInput.value); const spacing = parseInt(imageSpacingInput.value);
            try {
                await processImages(selectedImages, targetWidth, spacing);
                processBtn.textContent = 'æ‹¼æ¥å®Œæˆ âœ“'; processBtn.classList.remove('animate-pulse'); processBtn.classList.add('bg-green-600', 'hover:bg-green-700'); processBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700'); reprocessBtn.classList.remove('hidden');
            } catch (error) {
                alert('è™•ç†åœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message); processBtn.disabled = false; processBtn.textContent = 'é–‹å§‹æ‹¼æ¥'; processBtn.classList.remove('animate-pulse');
            }
        }

        async function processImages(files, targetWidth, spacing) {
            const canvas = resultCanvas; const ctx = canvas.getContext('2d');
            try {
                progressText.textContent = `æ­£åœ¨è¼‰å…¥ ${files.length} å¼µåœ–ç‰‡...`; progressBar.style.width = '10%';
                const imagePromises = files.map((file, index) => loadImageWithTimeout(file, 15000).catch(error => { throw new Error(`è¼‰å…¥åœ–ç‰‡ "${file.name}" å¤±æ•—: ${error.message}`); }));
                const images = await Promise.all(imagePromises);
                progressBar.style.width = '50%'; progressText.textContent = 'è¨ˆç®—ç•«å¸ƒå°ºå¯¸...';
                let totalHeight = 0; const scaledImages = [];
                for (let i = 0; i < images.length; i++) {
                    const img = images[i]; const scale = targetWidth / img.width; const scaledHeight = img.height * scale;
                    scaledImages.push({ img: img, width: targetWidth, height: scaledHeight });
                    totalHeight += scaledHeight; if (i < images.length - 1) { totalHeight += spacing; }
                }
                progressBar.style.width = '60%'; progressText.textContent = 'å»ºç«‹ç•«å¸ƒ...';
                canvas.width = targetWidth; canvas.height = totalHeight;
                ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, targetWidth, totalHeight);
                progressText.textContent = 'æ‹¼æ¥åœ–ç‰‡ä¸­...'; progressBar.style.width = '80%';
                let currentY = 0;
                for (let i = 0; i < scaledImages.length; i++) {
                    const scaledImg = scaledImages[i]; ctx.drawImage(scaledImg.img, 0, currentY, scaledImg.width, scaledImg.height); currentY += scaledImg.height + spacing;
                }
                progressText.textContent = 'æ‹¼æ¥å®Œæˆï¼'; progressBar.style.width = '100%';
                document.getElementById('finalDimensions').textContent = `${targetWidth} x ${Math.round(totalHeight)} åƒç´ `;
                resultArea.classList.remove('hidden'); downloadBtn.classList.remove('hidden'); resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) { throw error; }
        }

        function loadImageWithTimeout(file, timeout = 15000) {
            return new Promise((resolve, reject) => {
                const img = new Image(); let timeoutId; let objectUrl;
                const cleanup = () => { if (timeoutId) clearTimeout(timeoutId); if (objectUrl) URL.revokeObjectURL(objectUrl); };
                img.onload = () => { cleanup(); resolve(img); };
                img.onerror = () => { cleanup(); reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—')); };
                timeoutId = setTimeout(() => { cleanup(); reject(new Error('åœ–ç‰‡è¼‰å…¥è¶…æ™‚')); }, timeout);
                try { objectUrl = URL.createObjectURL(file); img.src = objectUrl; } catch (error) { cleanup(); reject(new Error('ç„¡æ³•è®€å–æª”æ¡ˆ')); }
            });
        }

        downloadBtn.addEventListener('click', async () => {
            const format = outputFormatInput.value; const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png'; const extension = format === 'jpeg' ? 'jpg' : 'png'; const quality = format === 'jpeg' ? 0.9 : undefined;
            const customName = customFileNameInput.value.trim();
            let fileName = (customName && customName !== 'æ‹¼æ¥é•·åœ–') ? `${customName}.${extension}` : `æ‹¼æ¥é•·åœ–_${new Date().getTime()}.${extension}`;
            if (customSaveHandle && 'showDirectoryPicker' in window) {
                try {
                    const blob = await new Promise(resolve => { resultCanvas.toBlob(resolve, mimeType, quality); });
                    const fileHandle = await customSaveHandle.getFileHandle(fileName, { create: true });
                    const writable = await fileHandle.createWritable(); await writable.write(blob); await writable.close();
                    alert(`æª”æ¡ˆå·²æˆåŠŸå„²å­˜åˆ°æŒ‡å®šä½ç½®ï¼š${fileName}`);
                } catch (error) { console.log('Error saving:', error); fallbackDownload(); }
            } else { fallbackDownload(); }
            function fallbackDownload() { const link = document.createElement('a'); link.download = fileName; link.href = resultCanvas.toDataURL(mimeType, quality); link.click(); }
        });
    </script>
</body>
</html>
